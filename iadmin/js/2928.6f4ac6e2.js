"use strict";(globalThis["webpackChunkimagina_cms"]=globalThis["webpackChunkimagina_cms"]||[]).push([[2928],{35800:(t,e,a)=>{a.r(e),a.d(e,{default:()=>E});var n=a(92444),o=a(74044);const i={id:"appointmentAssignedIndex"},s={id:"appointmentAssignedIndexContent",class:"box relative-position",style:{padding:"0"}},l={key:0},d={key:0,class:"box box-auto-height"},m={class:"text-grey-7 q-mr-xs"},r={key:1},p={class:"text-grey-7 q-mr-xs"},c={class:"text-grey-7 q-mr-xs"},h={class:"text-grey-7 q-mr-xs"},u={key:2,class:"box box-auto-height"},g={class:"text-right"};function f(t,e,a,f,v,b){const y=(0,n.E1)("advanced-chat"),A=(0,n.E1)("not-result"),$=(0,n.E1)("dynamic-field"),R=(0,n.E1)("q-btn"),S=(0,n.E1)("master-modal"),x=(0,n.E1)("dynamic-form"),E=(0,n.E1)("inner-loading");return(0,n.Wz)(),(0,n.An)("div",i,[(0,n.QD)("div",s,[v.loading?(0,n.g1)("",!0):((0,n.Wz)(),(0,n.Az)(y,{key:0,"rooms-id":b.assignedConversations.conversationsId,onRoomOpened:e[0]||(e[0]=e=>v.selectedRommId=t.$clone(e)),"advanced-props":b.advancedChatProps,height:"calc(100vh - 200px)","load-rooms":!!b.assignedConversations.conversationsId.length},null,8,["rooms-id","advanced-props","load-rooms"])),(0,n.K2)(S,{modelValue:v.modal.show,"onUpdate:modelValue":e[2]||(e[2]=t=>v.modal.show=t),title:v.modal.title||"",loading:v.modal.loading},{default:(0,n.Ql)((()=>[b.appointmentSelected?((0,n.Wz)(),(0,n.An)("div",l,["showInformation"==v.modal.type?((0,n.Wz)(),(0,n.An)("div",d,[((0,n.Wz)(!0),(0,n.An)(n.ae,null,(0,n.mi)(b.appointmentSelected.fields||[],((t,e)=>((0,n.Wz)(),(0,n.An)("div",{key:e,class:"appt-card__fields-field q-py-xs"},[(0,n.QD)("label",m,(0,o.WA)(t.name)+":",1),(0,n.QD)("label",null,(0,o.WA)(t.value),1)])))),128))])):"showSubscription"==v.modal.type?((0,n.Wz)(),(0,n.An)("div",r,[v.modal.loading||v.modal.data&&v.modal.data.length?(0,n.g1)("",!0):((0,n.Wz)(),(0,n.Az)(A,{key:0})),((0,n.Wz)(!0),(0,n.An)(n.ae,null,(0,n.mi)(v.modal.data||[],((e,a)=>((0,n.Wz)(),(0,n.An)("div",{key:a,class:"box box-auto-height q-py-xs q-mb-sm"},[(0,n.QD)("div",null,[(0,n.QD)("label",p,(0,o.WA)(t.$tr("isite.cms.form.name"))+":",1),(0,n.QD)("label",null,(0,o.WA)(e.name),1)]),(0,n.QD)("div",null,[(0,n.QD)("label",c,(0,o.WA)(t.$tr("qplan.layout.form.startDate"))+":",1),(0,n.QD)("label",null,(0,o.WA)(t.$trd(e.startDate)),1)]),(0,n.QD)("div",null,[(0,n.QD)("label",h,(0,o.WA)(t.$tr("qplan.layout.form.endDate"))+":",1),(0,n.QD)("label",null,(0,o.WA)(t.$trd(e.endDate)),1)])])))),128))])):((0,n.Wz)(),(0,n.An)("div",u,[(0,n.K2)($,{modelValue:v.fieldValue[v.modal.type],"onUpdate:modelValue":e[1]||(e[1]=t=>v.fieldValue[v.modal.type]=t),field:b.actionsFields[v.modal.type],class:"q-mb-md"},null,8,["modelValue","field"]),(0,n.QD)("div",g,[(0,n.K2)(R,{label:t.$tr("isite.cms.label.save"),icon:"fas fa-save",rounded:"",unelevated:"",color:"green",onClick:b.updateAppointment},null,8,["label","onClick"])])]))])):(0,n.g1)("",!0)])),_:1},8,["modelValue","title","loading"]),(0,n.K2)(S,{modelValue:v.modalReportError,"onUpdate:modelValue":e[4]||(e[4]=t=>v.modalReportError=t),title:t.$tr("iappointment.cms.message.reportError"),loading:v.modal.loading},{default:(0,n.Ql)((()=>[b.formErrorId&&b.appointmentSelected?((0,n.Wz)(),(0,n.Az)(x,{key:0,"form-id":b.formErrorId,onSent:e[3]||(e[3]=t=>v.modalReportError=!1),"send-to":{apiRoute:"apiRoutes.qform.leads",extraData:{formId:b.formErrorId}}},null,8,["form-id","send-to"])):(0,n.g1)("",!0)])),_:1},8,["modelValue","title","loading"]),(0,n.K2)(E,{visible:v.loading},null,8,["visible"])])])}a(23816);var v=a(19058),b=a(8932);const y={beforeUnmount(){b.kN.off("page.data.refresh"),b.kN.off("iappointment.appoinment.was.changed")},props:{},components:{advancedChat:v.c},watch:{},mounted(){this.$nextTick((function(){this.init()}))},data(){return{loading:!1,appointments:[],selectedRommId:!1,modal:{loading:!1,show:!1,title:!1,type:!1,data:!1},modalReportError:!1,fieldValue:{addRecommendation:null,changeStatus:null}}},computed:{formErrorId(){return this.$getSetting("iappointment::errorFormRelated")},assignedConversations(){let t={conversations:[],conversationsId:[]},e=this.$clone(this.appointments);if(e){let a=e.filter((t=>t.conversation)),n=a.map((t=>t.conversation));t={conversations:n,conversationsId:n.map((t=>t.id))}}return this.$clone(t)},appointmentSelected(){if(!this.selectedRommId)return!1;let t=this.$clone(this.appointments.filter((t=>t.conversation)));return t.find((t=>t.conversation.id=this.selectedRommId))},advancedChatProps(){let t={menuActions:[{name:"showInformation",title:this.$tr("iappointment.cms.message.showInfo"),action:t=>{this.modal={show:!0,title:this.appointmentSelected.customer.fullName,type:"showInformation"}}},{name:"changeStatus",title:this.$tr("iappointment.cms.message.changeStatus"),action:t=>{this.modal={show:!0,title:this.$tr("iappointment.cms.message.changeStatus"),type:"changeStatus"}}},{name:"addRecommendation",title:this.$tr("iappointment.cms.message.addRecommendation"),action:t=>{this.modal={show:!0,title:this.$tr("iappointment.cms.message.addRecommendation"),type:"addRecommendation"}}}]};return this.$hasAccess("iplan.subscriptions.index")&&t.menuActions.push({name:"showSubscriptions",title:this.$tr("iappointment.cms.message.showSubscriptions"),action:t=>{this.modal={show:!0,title:this.$trp("isite.cms.label.subscription"),type:"showSubscription",loading:!0,data:!1},this.getCustomerSubscriptions()}}),this.formErrorId&&t.menuActions.push({name:"reportError",title:this.$tr("iappointment.cms.message.reportError"),action:t=>{this.modalReportError=!0}}),t},actionsFields(){let t=this.appointmentSelected.options&&this.appointmentSelected.options.recommendation||null;return{addRecommendation:{value:t,type:"html"},changeStatus:{value:null,type:"select",props:{label:this.$tr("isite.cms.form.status"),options:[{label:"Abandonado",value:4},{label:"Completado",value:6}]}}}}},methods:{init(){this.listenEvents(),this.getAppointments()},listenEvents(){b.kN.on("page.data.refresh",(()=>{this.getAppointments(!0)})),b.kN.on("iappointment.appoinment.was.changed",(t=>{this.$alert.info({mode:"modal",message:this.$tr("iappointment.cms.message.newAssignationMessage"),actions:[{label:this.$tr("isite.cms.label.refresh"),color:"green",handler:()=>this.getAppointments()}]})}))},getAppointments(t=!1){return new Promise(((t,e)=>{this.loading=!0;let a={refresh:!0,params:{include:"category,customer,assigned,status,fields,conversation",filter:{status:3}}};this.$crud.index("apiRoutes.qappointment.appointments",a).then((t=>{this.appointments=t.data,this.loading=!1})).catch((t=>{this.$apiResponse.handleError(t,(()=>{this.loading=!1}))}))}))},updateAppointment(){this.modal.loading=!0;let t=this.$clone(this.appointmentSelected);"changeStatus"==this.modal.type&&(t.statusId=this.fieldValue.changeStatus),"addRecommendation"==this.modal.type&&(t.options={...t.options||{},recommendation:this.fieldValue.addRecommendation}),this.$crud.update("apiRoutes.qappointment.appointments",this.appointmentSelected.id,t).then((e=>{"addRecommendation"==this.modal.type&&this.appointments.forEach(((e,a)=>{e.id==t.id&&(this.appointments[a]=this.$clone(t))})),"changeStatus"==this.modal.type&&this.getAppointments(),this.modal={loading:!1,show:!1,title:!1,type:!1}})).catch((t=>{this.modal.loading=!1}))},getCustomerSubscriptions(){return new Promise(((t,e)=>{let a={params:{filter:{user:this.appointmentSelected.customerId,status:1}}};this.$crud.index("apiRoutes.qplan.subscriptions",a).then((t=>{this.modal.loading=!1,this.modal.data=t.data})).catch((t=>{this.$apiResponse.handleError(t,(()=>{this.modal.loading=!1,e(t)}))}))}))}}};var A=a(68716),$=a(99140),R=a(95252),S=a.n(R);const x=(0,A.c)(y,[["render",f]]),E=x;S()(y,"components",{QBtn:$.c})}}]);
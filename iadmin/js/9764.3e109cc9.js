"use strict";(globalThis["webpackChunkadmin_quasar"]=globalThis["webpackChunkadmin_quasar"]||[]).push([[9764],{89764:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ce});var s=i(61758),a=i(58790);const r={id:"panelReservationForm"},l={key:0},o={key:1,class:"q-container"},c={key:0,class:"box text-center"},n={class:"q-py-lg"},d={class:"text-grey-8 q-mb-md"},u={class:"text-h5"},v={key:0},h={key:0,class:"q-px-sm q-mb-md"},m={class:"row q-gutter-md justify-center"},p={key:1,class:"box relative-position"},g={class:"col-12 text-primary text-weight-bold text-subtitle1 text-center q-mb-md"},b={class:"ellipsis text-weight-bold"},k=["innerHTML"],f={class:"text-weight-bold text-subtitle1 text-grey-8"},y={class:"text-grey-8"},$={class:"text-center q-mb-md"},F={class:"row q-col-gutter-sm"},x=["onClick"],I={class:"row q-col-gutter-sm"},R=["onClick"],q={class:"text-left"},_={class:"text-grey-6 text-caption"},C={class:"row q-col-gutter-sm"},S=["onClick"],w={class:"text-left"},L={class:"text-grey-6 text-caption"},A={class:"row q-col-gutter-md"},D={key:0,class:"q-mt-md"},X={key:1,class:"row q-col-gutter-sm"},T=["onClick"],E={class:"text-left"},Q={class:"text-grey-6 text-caption"},V={class:"q-mb-xs"},W={class:"text-blue"},B={id:"actionsContent",class:"row"},P={class:"col-4"},K={class:"col-8 text-right"};function U(e,t,i,U,O,M){const Y=(0,s.g2)("not-found"),j=(0,s.g2)("q-icon"),z=(0,s.g2)("q-item-label"),H=(0,s.g2)("q-item-section"),N=(0,s.g2)("q-item"),J=(0,s.g2)("q-list"),G=(0,s.g2)("q-separator"),Z=(0,s.g2)("q-btn"),ee=(0,s.g2)("q-banner"),te=(0,s.g2)("q-tab-panel"),ie=(0,s.g2)("q-tab-panels"),se=(0,s.g2)("q-option-group"),ae=(0,s.g2)("q-scroll-area"),re=(0,s.g2)("dynamic-form"),le=(0,s.g2)("dynamic-field"),oe=(0,s.g2)("not-result"),ce=(0,s.g2)("inner-loading");return(0,s.uX)(),(0,s.CE)("div",r,[M.allowPublicReservation?((0,s.uX)(),(0,s.CE)("div",o,[O.successReserve?((0,s.uX)(),(0,s.CE)("div",c,[(0,s.Lk)("div",n,[(0,s.bF)(j,{name:"fas fa-check-circle",color:"green",size:"50px",class:"q-mb-md"}),(0,s.Lk)("div",d,[(0,s.Lk)("div",u," ยก"+(0,a.v_)(e.$tr("isite.cms.label.reserved"))+" "+(0,a.v_)(O.reservationData?`#${O.reservationData.id}`:"")+"! ",1),O.reservationData?((0,s.uX)(),(0,s.CE)("div",v,(0,a.v_)(e.$tr("isite.cms.label.state"))+": "+(0,a.v_)(O.reservationData.statusName),1)):(0,s.Q3)("",!0)]),O.reservationData?((0,s.uX)(),(0,s.CE)("div",h,[(0,s.bF)(J,{bordered:"",separator:""},{default:(0,s.k6)((()=>[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.reservationData.items,((t,i)=>((0,s.uX)(),(0,s.Wv)(N,{key:i},{default:(0,s.k6)((()=>[(0,s.bF)(H,{class:"text-grey-9 text-left"},{default:(0,s.k6)((()=>[t.categoryTitle?((0,s.uX)(),(0,s.Wv)(z,{key:0},{default:(0,s.k6)((()=>[(0,s.eW)((0,a.v_)(t.categoryTitle),1)])),_:2},1024)):(0,s.Q3)("",!0),t.serviceTitle?((0,s.uX)(),(0,s.Wv)(z,{key:1},{default:(0,s.k6)((()=>[(0,s.eW)((0,a.v_)(t.serviceTitle),1)])),_:2},1024)):(0,s.Q3)("",!0),t.resourceTitle?((0,s.uX)(),(0,s.Wv)(z,{key:2},{default:(0,s.k6)((()=>[(0,s.eW)((0,a.v_)(t.resourceTitle),1)])),_:2},1024)):(0,s.Q3)("",!0),t.startDate?((0,s.uX)(),(0,s.Wv)(z,{key:3,class:"q-pt-sm"},{default:(0,s.k6)((()=>[(0,s.eW)((0,a.v_)(e.$trd(t.startDate,{type:"long"})),1)])),_:2},1024)):(0,s.Q3)("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])):(0,s.Q3)("",!0),(0,s.bF)(G,{class:"q-mb-md"}),(0,s.Lk)("div",m,[(0,s.bF)(Z,{label:e.$tr("ibooking.cms.newReservation"),color:"blue",rounded:"",unelevated:"",onClick:t[0]||(t[0]=e=>M.actionAfterReservation(!0)),flat:""},null,8,["label"]),(0,s.bF)(Z,{label:e.$tr("isite.cms.label.finalize"),color:"green",rounded:"",unelevated:"",onClick:t[1]||(t[1]=e=>M.actionAfterReservation()),flat:""},null,8,["label"])])])])):((0,s.uX)(),(0,s.CE)("div",p,[(0,s.Lk)("div",g,(0,a.v_)(e.$tr("ibooking.cms.newReservation")),1),O.resourceData?((0,s.uX)(),(0,s.Wv)(ee,{key:0,id:"bannerResourceData",class:"bg-primary text-white"},{avatar:(0,s.k6)((()=>[(0,s.Lk)("div",{class:"resource-image img-as-bg",style:(0,a.Tr)(`background-image : url('${O.resourceData?.mediaFiles?.mainimage.path}')`)},null,4)])),default:(0,s.k6)((()=>[(0,s.Lk)("div",b,(0,a.v_)(O.resourceData.title),1),(0,s.Lk)("div",{class:"ellipsis-2-lines text-caption",innerHTML:O.resourceData.description},null,8,k)])),_:1})):((0,s.uX)(),(0,s.Wv)(G,{key:1,class:"q-mb-sm"})),(0,s.bF)(ie,{modelValue:O.step,"onUpdate:modelValue":t[2]||(t[2]=e=>O.step=e),animated:""},{default:(0,s.k6)((()=>[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(M.steps,((e,t)=>((0,s.uX)(),(0,s.Wv)(te,{key:t,name:e,class:"text-center"},{default:(0,s.k6)((()=>[(0,s.Lk)("div",f,(0,a.v_)(M.headerSteps[e].title),1),(0,s.Lk)("div",y,(0,a.v_)(M.headerSteps[e].description),1)])),_:2},1032,["name"])))),128))])),_:1},8,["modelValue"]),(0,s.Lk)("div",$,[(0,s.bF)(se,{modelValue:O.step,"onUpdate:modelValue":t[3]||(t[3]=e=>O.step=e),inline:"",dense:"",size:"30px",options:M.optionsRadioTabs,disable:""},null,8,["modelValue","options"])]),(0,s.bF)(ie,{modelValue:O.step,"onUpdate:modelValue":t[7]||(t[7]=e=>O.step=e),animated:"",ref:"stepsForm","keep-alive":""},{default:(0,s.k6)((()=>[(0,s.bF)(te,{name:"category"},{default:(0,s.k6)((()=>[(0,s.bF)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.k6)((()=>[(0,s.Lk)("div",F,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.categories,((e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"col-12",onClick:t=>M.selectItem("categoryId",e.id)},[(0,s.Lk)("div",{class:(0,a.C4)(`item-selectable ${M.classSelected("categoryId",e.id)}`)},[(0,s.bF)(j,{name:"fas fa-layer-group"}),(0,s.Lk)("label",null,(0,a.v_)(e.title),1)],2)],8,x)))),128))])])),_:1})])),_:1}),(0,s.bF)(te,{name:"service"},{default:(0,s.k6)((()=>[(0,s.bF)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.k6)((()=>[(0,s.Lk)("div",I,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.services,((e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"col-12",onClick:t=>M.selectItem("serviceId",e.id)},[(0,s.Lk)("div",{class:(0,a.C4)(`item-selectable row items-center ${M.classSelected("serviceId",e.id)}`)},[(0,s.bF)(j,{name:"fas fa-concierge-bell"}),(0,s.Lk)("div",q,[(0,s.Lk)("div",null,(0,a.v_)(e.title),1),(0,s.Lk)("label",_,(0,a.v_)(M.selected.category.title),1)])],2)],8,R)))),128))])])),_:1})])),_:1}),O.serviceForm.id?((0,s.uX)(),(0,s.Wv)(te,{key:0,name:"formService"},{default:(0,s.k6)((()=>[(0,s.bF)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.k6)((()=>[(0,s.bF)(re,{modelValue:O.serviceForm.fields,"onUpdate:modelValue":t[4]||(t[4]=e=>O.serviceForm.fields=e),"form-type":"grid","form-id":O.serviceForm.id,"no-actions":"",ref:"formService",onObtainedForm:t[5]||(t[5]=e=>O.serviceForm.data=e),onValidated:t[6]||(t[6]=e=>O.serviceForm.isValid=e)},null,8,["modelValue","form-id"])])),_:1})])),_:1})):(0,s.Q3)("",!0),O.filterByResource?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.Wv)(te,{key:1,name:"resource"},{default:(0,s.k6)((()=>[(0,s.bF)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.k6)((()=>[(0,s.Lk)("div",C,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.resources,((e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"col-12",onClick:t=>M.selectItem("resourceId",e.id)},[(0,s.Lk)("div",{class:(0,a.C4)(`item-selectable row items-center ${M.classSelected("resourceId",e.id)}`)},[(0,s.bF)(j,{name:"fas fa-chess-knight"}),(0,s.Lk)("div",w,[(0,s.Lk)("div",null,(0,a.v_)(e.title),1),(0,s.Lk)("label",L,(0,a.v_)(M.selected.category.title)+", "+(0,a.v_)(M.selected.service.title),1)])],2)],8,S)))),128))])])),_:1})])),_:1})),(0,s.bF)(te,{name:"date"},{default:(0,s.k6)((()=>[(0,s.Lk)("div",A,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(M.formFields,((e,t)=>((0,s.uX)(),(0,s.Wv)(le,{key:t,field:e,modelValue:O.filters[t],"onUpdate:modelValue":e=>O.filters[t]=e,class:"col-12"},null,8,["field","modelValue","onUpdate:modelValue"])))),128))])])),_:1}),(0,s.bF)(te,{name:"availability"},{default:(0,s.k6)((()=>[(0,s.bF)(ae,{style:{height:"370px",width:"100%"}},{default:(0,s.k6)((()=>[O.availabilities.length?((0,s.uX)(),(0,s.CE)("div",X,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.availabilities,((t,i)=>((0,s.uX)(),(0,s.CE)(s.FK,{key:i},[t.isBusy?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("div",{key:0,class:"col-12",onClick:e=>M.selectItem("availabilityId",t.id)},[(0,s.Lk)("div",{class:(0,a.C4)(`item-selectable row items-center ${M.classSelected("availabilityId",t.id)}`)},[(0,s.bF)(j,{name:"fas fa-chess-knight"}),(0,s.Lk)("div",E,[(0,s.Lk)("div",Q,(0,a.v_)(M.selected.category.title)+", "+(0,a.v_)(M.selected.service.title),1),(0,s.Lk)("div",V,(0,a.v_)(t.resource.title),1),(0,s.Lk)("div",W,(0,a.v_)(e.$trd(`${t.calendarDate} ${t.startTime}`,{type:"shortHuman"})),1)])],2)],8,T))],64)))),128))])):((0,s.uX)(),(0,s.CE)("div",D,[(0,s.bF)(oe)]))])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,s.bF)(G,{class:"q-mb-md q-mt-sm"}),(0,s.Lk)("div",B,[(0,s.Lk)("div",P,[(0,s.bF)(Z,(0,s.v6)({unelevated:"",rounded:""},M.stepActions.previous.props,{onClick:t[8]||(t[8]=e=>M.stepActions.previous.action())}),null,16)]),(0,s.Lk)("div",K,[M.stepActions.skip.vIf?((0,s.uX)(),(0,s.Wv)(Z,(0,s.v6)({key:0,unelevated:"",rounded:""},M.stepActions.skip.props,{class:"q-mr-sm",onClick:t[9]||(t[9]=e=>M.stepActions.skip.action())}),null,16)):(0,s.Q3)("",!0),(0,s.bF)(Z,(0,s.v6)({unelevated:"",rounded:"",onClick:t[10]||(t[10]=e=>M.stepActions.next.action())},M.stepActions.next.props),null,16)])]),(0,s.bF)(ce,{visible:O.loading},null,8,["visible"])]))])):((0,s.uX)(),(0,s.CE)("div",l,[(0,s.bF)(Y)]))])}i(10239);var O=i(99526)["A"];const M={props:{},components:{},watch:{},mounted(){this.$nextTick((function(){this.init()}))},data(){return{loading:!1,successReserve:!1,step:"category",filters:{categoryId:null,serviceId:null,resourceId:null,date:null,time:null,availabilityId:null},filterByResource:this.$route.query.resource,resourceData:!1,categories:[],services:[],resources:[],availabilities:[],serviceForm:{},reservationData:null}},computed:{settings(){var e=this.$getSetting("ibooking::timeRangeFilter")||"{}";return{timeRangeFilter:"string"===typeof e?JSON.parse(e):e,allowPublicReservation:parseInt(this.$getSetting("ibooking::allowPublicReservation"))}},allowPublicReservation(){return!(!this.settings.allowPublicReservation&&!this.$store.state.quserAuth.userId)},optTimeFilter(){let e=[],t=Object.keys(this.settings.timeRangeFilter).filter((e=>e.includes("label"))),i=this.settings.timeRangeFilter;return t.forEach(((t,s)=>{let a=s+1;i[`label${a}`]&&i[`startTime${a}`]&&i[`endTime${a}`]&&e.push({label:i[t],value:a})})),e},steps(){let e=this.filterByResource?["category","service","date","availability"]:["category","service","resource","date","availability"];return this.serviceForm.id&&e.splice(2,0,"formService"),e},headerSteps(){return{category:{title:this.$tr("ibooking.cms.titleStepCategory"),description:this.$tr("ibooking.cms.descriptionStepCategory")},service:{title:this.$tr("ibooking.cms.titleStepService"),description:this.$tr("ibooking.cms.descriptionStepService")},formService:{title:this.serviceForm.data?.title||this.$tr("ibooking.cms.titleStepService"),description:""},resource:{title:this.$tr("ibooking.cms.titleStepResource"),description:this.$tr("ibooking.cms.descriptionStepResource")},date:{title:this.$tr("ibooking.cms.titleStepDate"),description:this.$tr("ibooking.cms.descriptionStepDate")},availability:{title:this.$tr("ibooking.cms.titleStepAvailability"),description:this.$tr("ibooking.cms.descriptionStepAvailability")}}},optionsRadioTabs(){return this.steps.map((e=>({label:"",value:e})))},stepActions(){return{previous:{props:{label:this.$tr("isite.cms.label.back"),color:"grey-7",outline:!0},action:()=>this.$refs.stepsForm.previous()},skip:{props:{label:this.$tr("isite.cms.label.skip"),color:"grey-7",outline:!0},vIf:["resource","date"].includes(this.step),action:()=>this.$refs.stepsForm.next()},next:{props:{label:this.$tr("isite.cms.label.next"),color:"green",disable:!!["category","service","availability"].includes(this.step)&&!this.filters[`${this.step}Id`]},action:()=>{let e={category:!this.filterByResource&&(()=>this.getServices(!0)),service:()=>!this.filterByResource&&this.getResources(!0),formService:()=>{this.$refs.formService&&this.$refs.formService.changeStep("next",!0),setTimeout((()=>{this.serviceForm.isValid&&this.$refs.stepsForm.next()}),200)},date:()=>this.getAvailabilities(!0),availability:()=>this.createReservation()};e[this.step]&&e[this.step](),["formService","availability"].includes(this.step)||this.$refs.stepsForm.next()}}}},selected(){let e=this.categories.find((e=>e.id==this.filters.categoryId)),t=this.services.find((e=>e.id==this.filters.serviceId)),i=this.availabilities.find((e=>e.id==this.filters.availabilityId));return{category:e||{},service:t||{},availability:i||{}}},formFields(){return{date:{type:"date",props:{clearable:!0,label:this.$tr("ibooking.cms.chooseDateReservation"),options:e=>e>=this.$moment().format("YYYY/MM/DD")}},time:{type:"select",props:{clearable:!0,label:this.$tr("ibooking.cms.chooseTimeReservation"),options:this.optTimeFilter}}}},dataServiceForm(){let e={};try{e=JSON.parse(this.$route.query.fields)}catch{}return{id:null,data:null,isValid:!1,fields:this.$clone(e)}}},methods:{init(){this.serviceForm=this.$clone(this.dataServiceForm),this.successReserve=!1,this.getData(!0)},async getData(e=!1){this.loading=!0,await this.getResourceData(!0),this.filterByResource||await this.getCategories(!0),this.loading=!1},getResourceData(e=!1){return new Promise(((t,i)=>{this.resourceData=!1;let s=this.filterByResource||("ipanel"==O("app.mode")?this.$store.state.quserAuth.userId:null);if(!s)return t(null);let a={refresh:e,params:{include:"services.category",filter:{field:this.filterByResource?"id":"created_by"}}};this.$crud.show("apiRoutes.qbooking.resources",s,a).then((e=>{if(!e.data)return t(null);if(this.filterByResource=s,this.resourceData=e.data,this.selectItem("resourceId",this.filterByResource),this.categories=Object.values(this.resourceData.services).map((e=>e.category)),this.categories=[...new Map(this.categories.map((e=>[e["id"],e]))).values()],this.services=this.resourceData.services,this.$route.query.service){let e=this.services.find((e=>e.id==this.$route.query.service));e&&(this.selectItem("serviceId",e.id),this.selectItem("categoryId",e.categoryId),this.step=e.formId?"formService":"date")}t(e.data)})).catch((e=>{t(e)}))}))},getCategories(e=!1){return new Promise(((t,i)=>{this.categories=[];let s={refresh:e,params:{filter:{hasServices:!0}}};this.$crud.index("apiRoutes.qbooking.categories",s).then((e=>{this.categories=e.data,t(e.data)})).catch((e=>{this.$apiResponse.handleError(e,(()=>{t(e)}))}))}))},getServices(e=!1){return new Promise(((t,i)=>{this.loading=!0,this.services=[];let s={refresh:e,params:{filter:{categoryId:this.filters.categoryId}}};this.$crud.index("apiRoutes.qbooking.services",s).then((e=>{this.services=e.data,t(e.data),this.loading=!1})).catch((e=>{this.$apiResponse.handleError(e,(()=>{this.loading=!1,i(e)}))}))}))},getResources(e=!1){return new Promise(((t,i)=>{this.loading=!0,this.resources=[];let s={refresh:e,params:{filter:{services:[this.filters.serviceId]}}};this.$crud.index("apiRoutes.qbooking.resources",s).then((e=>{this.resources=e.data,t(e.data),this.loading=!1})).catch((e=>{this.$apiResponse.handleError(e,(()=>{this.loading=!1,i(e)}))}))}))},getAvailabilities(e=!1){return new Promise(((t,i)=>{this.loading=!0,this.availabilities=[];let s={refresh:e,params:{filter:this.$clone(this.filters)}};this.filters.time&&(s.params.filter.time=[this.settings.timeRangeFilter[`startTime${this.filters.time}`],this.settings.timeRangeFilter[`endTime${this.filters.time}`]]),this.$crud.index("apiRoutes.qbooking.availabilities",s).then((e=>{this.availabilities=e.data.map((e=>({...e,id:this.$uid()}))),t(e.data),this.loading=!1})).catch((e=>{this.$apiResponse.handleError(e,(()=>{this.loading=!1,i(e)}))}))}))},selectItem(e,t){if(this.filters[e]=this.filters[e]==t?null:t,"serviceId"==e){let e=this.services.find((e=>e.id==t));this.serviceForm={...this.$clone(this.dataServiceForm),id:e.formId}}},classSelected(e,t){return this.filters[e]==t?"selected":""},createReservation(){return new Promise(((e,t)=>{this.loading=!0;let i={customerId:this.$store.state.quserAuth.userId,items:[{...this.serviceForm.fields,categoryId:this.selected.category.id,categoryTitle:this.selected.category.title,serviceId:this.selected.service.id,serviceTitle:this.selected.service.title,price:this.selected.service.price,resourceId:this.selected.availability.resource.id,resourceTitle:this.selected.availability.resource.title,startDate:`${this.selected.availability.calendarDate} ${this.selected.availability.startTime}`,endDate:`${this.selected.availability.calendarDate} ${this.selected.availability.endTime}`}]};this.$crud.create("apiRoutes.qbooking.reservations",i).then((e=>{this.successReserve=!0,this.reservationData=e.data.reservation,e.data&&e.data.redirectTo&&this.$helper.openExternalURL(e.data.redirectTo,!0),this.loading=!1})).catch((e=>{this.loading=!1}))}))},actionAfterReservation(e=!1){e?window.location.reload():this.$store.state.quserAuth.authenticated?this.$router.push({name:"qbooking.panel.reservations.index"}):window.location.href=this.$store.state.qsiteApp.baseUrl}}};var Y=i(12807),j=i(24609),z=i(54514),H=i(75329),N=i(63418),J=i(35779),G=i(37015),Z=i(69001),ee=i(38222),te=i(64082),ie=i(63815),se=i(76100),ae=i(19600),re=i(98582),le=i.n(re);const oe=(0,Y.A)(M,[["render",U]]),ce=oe;le()(M,"components",{QIcon:j.A,QList:z.A,QItem:H.A,QItemSection:N.A,QItemLabel:J.A,QSeparator:G.A,QBtn:Z.A,QBanner:ee.A,QTabPanels:te.A,QTabPanel:ie.A,QOptionGroup:se.A,QScrollArea:ae.A})}}]);
"use strict";(globalThis["webpackChunkimagina_cms"]=globalThis["webpackChunkimagina_cms"]||[]).push([[4996],{24996:(e,t,i)=>{i.r(t),i.d(t,{default:()=>oe});var s=i(92444),a=i(74044);const l={id:"panelReservationForm"},r={key:0},o={key:1,class:"q-container"},c={key:0,class:"box text-center"},n={class:"q-py-lg"},d={class:"text-grey-8 q-mb-md"},u={class:"text-h5"},h={key:0},m={key:0,class:"q-px-sm q-mb-md"},v={class:"row q-gutter-md justify-center"},p={key:1,class:"box relative-position"},g={class:"col-12 text-primary text-weight-bold text-subtitle1 text-center q-mb-md"},b={class:"ellipsis text-weight-bold"},f=["innerHTML"],y={class:"text-weight-bold text-subtitle1 text-grey-8"},k={class:"text-grey-8"},$={class:"text-center q-mb-md"},A={class:"row q-col-gutter-sm"},Q=["onClick"],D={class:"row q-col-gutter-sm"},W=["onClick"],x={class:"text-left"},R={class:"text-grey-6 text-caption"},q={class:"row q-col-gutter-sm"},z=["onClick"],I={class:"text-left"},S={class:"text-grey-6 text-caption"},w={class:"row q-col-gutter-md"},F={key:0,class:"q-mt-md"},T={key:1,class:"row q-col-gutter-sm"},K=["onClick"],_={class:"text-left"},E={class:"text-grey-6 text-caption"},C={class:"q-mb-xs"},V={class:"text-blue"},B={id:"actionsContent",class:"row"},P={class:"col-4"},N={class:"col-8 text-right"};function U(e,t,i,U,Y,M){const O=(0,s.E1)("not-found"),L=(0,s.E1)("q-icon"),G=(0,s.E1)("q-item-label"),j=(0,s.E1)("q-item-section"),H=(0,s.E1)("q-item"),J=(0,s.E1)("q-list"),X=(0,s.E1)("q-separator"),Z=(0,s.E1)("q-btn"),ee=(0,s.E1)("q-banner"),te=(0,s.E1)("q-tab-panel"),ie=(0,s.E1)("q-tab-panels"),se=(0,s.E1)("q-option-group"),ae=(0,s.E1)("q-scroll-area"),le=(0,s.E1)("dynamic-form"),re=(0,s.E1)("dynamic-field"),oe=(0,s.E1)("not-result"),ce=(0,s.E1)("inner-loading");return(0,s.Wz)(),(0,s.An)("div",l,[M.allowPublicReservation?((0,s.Wz)(),(0,s.An)("div",o,[Y.successReserve?((0,s.Wz)(),(0,s.An)("div",c,[(0,s.QD)("div",n,[(0,s.K2)(L,{name:"fas fa-check-circle",color:"green",size:"50px",class:"q-mb-md"}),(0,s.QD)("div",d,[(0,s.QD)("div",u," ยก"+(0,a.WA)(e.$tr("isite.cms.label.reserved"))+" "+(0,a.WA)(Y.reservationData?`#${Y.reservationData.id}`:"")+"! ",1),Y.reservationData?((0,s.Wz)(),(0,s.An)("div",h,(0,a.WA)(e.$tr("isite.cms.label.state"))+": "+(0,a.WA)(Y.reservationData.statusName),1)):(0,s.g1)("",!0)]),Y.reservationData?((0,s.Wz)(),(0,s.An)("div",m,[(0,s.K2)(J,{bordered:"",separator:""},{default:(0,s.Ql)((()=>[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(Y.reservationData.items,((t,i)=>((0,s.Wz)(),(0,s.Az)(H,{key:i},{default:(0,s.Ql)((()=>[(0,s.K2)(j,{class:"text-grey-9 text-left"},{default:(0,s.Ql)((()=>[t.categoryTitle?((0,s.Wz)(),(0,s.Az)(G,{key:0},{default:(0,s.Ql)((()=>[(0,s.mY)((0,a.WA)(t.categoryTitle),1)])),_:2},1024)):(0,s.g1)("",!0),t.serviceTitle?((0,s.Wz)(),(0,s.Az)(G,{key:1},{default:(0,s.Ql)((()=>[(0,s.mY)((0,a.WA)(t.serviceTitle),1)])),_:2},1024)):(0,s.g1)("",!0),t.resourceTitle?((0,s.Wz)(),(0,s.Az)(G,{key:2},{default:(0,s.Ql)((()=>[(0,s.mY)((0,a.WA)(t.resourceTitle),1)])),_:2},1024)):(0,s.g1)("",!0),t.startDate?((0,s.Wz)(),(0,s.Az)(G,{key:3,class:"q-pt-sm"},{default:(0,s.Ql)((()=>[(0,s.mY)((0,a.WA)(e.$trd(t.startDate,{type:"long"})),1)])),_:2},1024)):(0,s.g1)("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])):(0,s.g1)("",!0),(0,s.K2)(X,{class:"q-mb-md"}),(0,s.QD)("div",v,[(0,s.K2)(Z,{label:e.$tr("ibooking.cms.newReservation"),color:"blue",rounded:"",unelevated:"",onClick:t[0]||(t[0]=e=>M.actionAfterReservation(!0)),flat:""},null,8,["label"]),(0,s.K2)(Z,{label:e.$tr("isite.cms.label.finalize"),color:"green",rounded:"",unelevated:"",onClick:t[1]||(t[1]=e=>M.actionAfterReservation()),flat:""},null,8,["label"])])])])):((0,s.Wz)(),(0,s.An)("div",p,[(0,s.QD)("div",g,(0,a.WA)(e.$tr("ibooking.cms.newReservation")),1),Y.resourceData?((0,s.Wz)(),(0,s.Az)(ee,{key:0,id:"bannerResourceData",class:"bg-primary text-white"},{avatar:(0,s.Ql)((()=>[(0,s.QD)("div",{class:"resource-image img-as-bg",style:(0,a.MN)(`background-image : url('${Y.resourceData?.mediaFiles?.mainimage.path}')`)},null,4)])),default:(0,s.Ql)((()=>[(0,s.QD)("div",b,(0,a.WA)(Y.resourceData.title),1),(0,s.QD)("div",{class:"ellipsis-2-lines text-caption",innerHTML:Y.resourceData.description},null,8,f)])),_:1})):((0,s.Wz)(),(0,s.Az)(X,{key:1,class:"q-mb-sm"})),(0,s.K2)(ie,{modelValue:Y.step,"onUpdate:modelValue":t[2]||(t[2]=e=>Y.step=e),animated:""},{default:(0,s.Ql)((()=>[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(M.steps,((e,t)=>((0,s.Wz)(),(0,s.Az)(te,{key:t,name:e,class:"text-center"},{default:(0,s.Ql)((()=>[(0,s.QD)("div",y,(0,a.WA)(M.headerSteps[e].title),1),(0,s.QD)("div",k,(0,a.WA)(M.headerSteps[e].description),1)])),_:2},1032,["name"])))),128))])),_:1},8,["modelValue"]),(0,s.QD)("div",$,[(0,s.K2)(se,{modelValue:Y.step,"onUpdate:modelValue":t[3]||(t[3]=e=>Y.step=e),inline:"",dense:"",size:"30px",options:M.optionsRadioTabs,disable:""},null,8,["modelValue","options"])]),(0,s.K2)(ie,{modelValue:Y.step,"onUpdate:modelValue":t[7]||(t[7]=e=>Y.step=e),animated:"",ref:"stepsForm","keep-alive":""},{default:(0,s.Ql)((()=>[(0,s.K2)(te,{name:"category"},{default:(0,s.Ql)((()=>[(0,s.K2)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.Ql)((()=>[(0,s.QD)("div",A,[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(Y.categories,((e,t)=>((0,s.Wz)(),(0,s.An)("div",{key:t,class:"col-12",onClick:t=>M.selectItem("categoryId",e.id)},[(0,s.QD)("div",{class:(0,a.WN)(`item-selectable ${M.classSelected("categoryId",e.id)}`)},[(0,s.K2)(L,{name:"fas fa-layer-group"}),(0,s.QD)("label",null,(0,a.WA)(e.title),1)],2)],8,Q)))),128))])])),_:1})])),_:1}),(0,s.K2)(te,{name:"service"},{default:(0,s.Ql)((()=>[(0,s.K2)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.Ql)((()=>[(0,s.QD)("div",D,[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(Y.services,((e,t)=>((0,s.Wz)(),(0,s.An)("div",{key:t,class:"col-12",onClick:t=>M.selectItem("serviceId",e.id)},[(0,s.QD)("div",{class:(0,a.WN)(`item-selectable row items-center ${M.classSelected("serviceId",e.id)}`)},[(0,s.K2)(L,{name:"fas fa-concierge-bell"}),(0,s.QD)("div",x,[(0,s.QD)("div",null,(0,a.WA)(e.title),1),(0,s.QD)("label",R,(0,a.WA)(M.selected.category.title),1)])],2)],8,W)))),128))])])),_:1})])),_:1}),Y.serviceForm.id?((0,s.Wz)(),(0,s.Az)(te,{key:0,name:"formService"},{default:(0,s.Ql)((()=>[(0,s.K2)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.Ql)((()=>[(0,s.K2)(le,{modelValue:Y.serviceForm.fields,"onUpdate:modelValue":t[4]||(t[4]=e=>Y.serviceForm.fields=e),"form-type":"grid","form-id":Y.serviceForm.id,"no-actions":"",ref:"formService",onObtainedForm:t[5]||(t[5]=e=>Y.serviceForm.data=e),onValidated:t[6]||(t[6]=e=>Y.serviceForm.isValid=e)},null,8,["modelValue","form-id"])])),_:1})])),_:1})):(0,s.g1)("",!0),Y.filterByResource?(0,s.g1)("",!0):((0,s.Wz)(),(0,s.Az)(te,{key:1,name:"resource"},{default:(0,s.Ql)((()=>[(0,s.K2)(ae,{style:{height:"350px",width:"100%"}},{default:(0,s.Ql)((()=>[(0,s.QD)("div",q,[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(Y.resources,((e,t)=>((0,s.Wz)(),(0,s.An)("div",{key:t,class:"col-12",onClick:t=>M.selectItem("resourceId",e.id)},[(0,s.QD)("div",{class:(0,a.WN)(`item-selectable row items-center ${M.classSelected("resourceId",e.id)}`)},[(0,s.K2)(L,{name:"fas fa-chess-knight"}),(0,s.QD)("div",I,[(0,s.QD)("div",null,(0,a.WA)(e.title),1),(0,s.QD)("label",S,(0,a.WA)(M.selected.category.title)+", "+(0,a.WA)(M.selected.service.title),1)])],2)],8,z)))),128))])])),_:1})])),_:1})),(0,s.K2)(te,{name:"date"},{default:(0,s.Ql)((()=>[(0,s.QD)("div",w,[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(M.formFields,((e,t)=>((0,s.Wz)(),(0,s.Az)(re,{key:t,field:e,modelValue:Y.filters[t],"onUpdate:modelValue":e=>Y.filters[t]=e,class:"col-12"},null,8,["field","modelValue","onUpdate:modelValue"])))),128))])])),_:1}),(0,s.K2)(te,{name:"availability"},{default:(0,s.Ql)((()=>[(0,s.K2)(ae,{style:{height:"370px",width:"100%"}},{default:(0,s.Ql)((()=>[Y.availabilities.length?((0,s.Wz)(),(0,s.An)("div",T,[((0,s.Wz)(!0),(0,s.An)(s.ae,null,(0,s.mi)(Y.availabilities,((t,i)=>((0,s.Wz)(),(0,s.An)(s.ae,{key:i},[t.isBusy?(0,s.g1)("",!0):((0,s.Wz)(),(0,s.An)("div",{key:0,class:"col-12",onClick:e=>M.selectItem("availabilityId",t.id)},[(0,s.QD)("div",{class:(0,a.WN)(`item-selectable row items-center ${M.classSelected("availabilityId",t.id)}`)},[(0,s.K2)(L,{name:"fas fa-chess-knight"}),(0,s.QD)("div",_,[(0,s.QD)("div",E,(0,a.WA)(M.selected.category.title)+", "+(0,a.WA)(M.selected.service.title),1),(0,s.QD)("div",C,(0,a.WA)(t.resource.title),1),(0,s.QD)("div",V,(0,a.WA)(e.$trd(`${t.calendarDate} ${t.startTime}`,{type:"shortHuman"})),1)])],2)],8,K))],64)))),128))])):((0,s.Wz)(),(0,s.An)("div",F,[(0,s.K2)(oe)]))])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,s.K2)(X,{class:"q-mb-md q-mt-sm"}),(0,s.QD)("div",B,[(0,s.QD)("div",P,[(0,s.K2)(Z,(0,s.Gu)({unelevated:"",rounded:""},M.stepActions.previous.props,{onClick:t[8]||(t[8]=e=>M.stepActions.previous.action())}),null,16)]),(0,s.QD)("div",N,[M.stepActions.skip.vIf?((0,s.Wz)(),(0,s.Az)(Z,(0,s.Gu)({key:0,unelevated:"",rounded:""},M.stepActions.skip.props,{class:"q-mr-sm",onClick:t[9]||(t[9]=e=>M.stepActions.skip.action())}),null,16)):(0,s.g1)("",!0),(0,s.K2)(Z,(0,s.Gu)({unelevated:"",rounded:"",onClick:t[10]||(t[10]=e=>M.stepActions.next.action())},M.stepActions.next.props),null,16)])]),(0,s.K2)(ce,{visible:Y.loading},null,8,["visible"])]))])):((0,s.Wz)(),(0,s.An)("div",r,[(0,s.K2)(O)]))])}i(23816);const Y={props:{},components:{},watch:{},mounted(){this.$nextTick((function(){this.init()}))},data(){return{loading:!1,successReserve:!1,step:"category",filters:{categoryId:null,serviceId:null,resourceId:null,date:null,time:null,availabilityId:null},filterByResource:this.$route.query.resource,resourceData:!1,categories:[],services:[],resources:[],availabilities:[],serviceForm:{},reservationData:null}},computed:{settings(){var e=this.$getSetting("ibooking::timeRangeFilter")||"{}";return{timeRangeFilter:"string"===typeof e?JSON.parse(e):e,allowPublicReservation:parseInt(this.$getSetting("ibooking::allowPublicReservation"))}},allowPublicReservation(){return!(!this.settings.allowPublicReservation&&!this.$store.state.quserAuth.userId)},optTimeFilter(){let e=[],t=Object.keys(this.settings.timeRangeFilter).filter((e=>e.includes("label"))),i=this.settings.timeRangeFilter;return t.forEach(((t,s)=>{let a=s+1;i[`label${a}`]&&i[`startTime${a}`]&&i[`endTime${a}`]&&e.push({label:i[t],value:a})})),e},steps(){let e=this.filterByResource?["category","service","date","availability"]:["category","service","resource","date","availability"];return this.serviceForm.id&&e.splice(2,0,"formService"),e},headerSteps(){return{category:{title:this.$tr("ibooking.cms.titleStepCategory"),description:this.$tr("ibooking.cms.descriptionStepCategory")},service:{title:this.$tr("ibooking.cms.titleStepService"),description:this.$tr("ibooking.cms.descriptionStepService")},formService:{title:this.serviceForm.data?.title||this.$tr("ibooking.cms.titleStepService"),description:""},resource:{title:this.$tr("ibooking.cms.titleStepResource"),description:this.$tr("ibooking.cms.descriptionStepResource")},date:{title:this.$tr("ibooking.cms.titleStepDate"),description:this.$tr("ibooking.cms.descriptionStepDate")},availability:{title:this.$tr("ibooking.cms.titleStepAvailability"),description:this.$tr("ibooking.cms.descriptionStepAvailability")}}},optionsRadioTabs(){return this.steps.map((e=>({label:"",value:e})))},stepActions(){return{previous:{props:{label:this.$tr("isite.cms.label.back"),color:"grey-7",outline:!0},action:()=>this.$refs.stepsForm.previous()},skip:{props:{label:this.$tr("isite.cms.label.skip"),color:"grey-7",outline:!0},vIf:["resource","date"].includes(this.step),action:()=>this.$refs.stepsForm.next()},next:{props:{label:this.$tr("isite.cms.label.next"),color:"green",disable:!!["category","service","availability"].includes(this.step)&&!this.filters[`${this.step}Id`]},action:()=>{let e={category:!this.filterByResource&&(()=>this.getServices(!0)),service:()=>!this.filterByResource&&this.getResources(!0),formService:()=>{this.$refs.formService&&this.$refs.formService.changeStep("next",!0),setTimeout((()=>{this.serviceForm.isValid&&this.$refs.stepsForm.next()}),200)},date:()=>this.getAvailabilities(!0),availability:()=>this.createReservation()};e[this.step]&&e[this.step](),["formService","availability"].includes(this.step)||this.$refs.stepsForm.next()}}}},selected(){let e=this.categories.find((e=>e.id==this.filters.categoryId)),t=this.services.find((e=>e.id==this.filters.serviceId)),i=this.availabilities.find((e=>e.id==this.filters.availabilityId));return{category:e||{},service:t||{},availability:i||{}}},formFields(){return{date:{type:"date",props:{clearable:!0,label:this.$tr("ibooking.cms.chooseDateReservation"),options:e=>e>=this.$moment().format("YYYY/MM/DD")}},time:{type:"select",props:{clearable:!0,label:this.$tr("ibooking.cms.chooseTimeReservation"),options:this.optTimeFilter}}}},dataServiceForm(){let e={};try{e=JSON.parse(this.$route.query.fields)}catch{}return{id:null,data:null,isValid:!1,fields:this.$clone(e)}}},methods:{init(){this.serviceForm=this.$clone(this.dataServiceForm),this.successReserve=!1,this.getData(!0)},async getData(e=!1){this.loading=!0,await this.getResourceData(!0),this.filterByResource||await this.getCategories(!0),this.loading=!1},getResourceData(e=!1){return new Promise(((t,i)=>{this.resourceData=!1;let s=this.$route.meta.authenticated?this.$store.state.quserAuth.userId:null;if(s=this.filterByResource||s,!s)return t(null);let a={refresh:e,params:{include:"services.category",filter:{field:this.filterByResource?"id":"created_by"}}};this.$crud.show("apiRoutes.qbooking.resources",s,a).then((e=>{if(!e.data)return t(null);if(this.filterByResource=s,this.resourceData=e.data,this.selectItem("resourceId",this.filterByResource),this.categories=Object.values(this.resourceData.services).map((e=>e.category)),this.categories=[...new Map(this.categories.map((e=>[e["id"],e]))).values()],this.services=this.resourceData.services,this.$route.query.service){let e=this.services.find((e=>e.id==this.$route.query.service));e&&(this.selectItem("serviceId",e.id),this.selectItem("categoryId",e.categoryId),this.step=e.formId?"formService":"date")}t(e.data)})).catch((e=>{t(e)}))}))},getCategories(e=!1){return new Promise(((t,i)=>{this.categories=[];let s={refresh:e,params:{filter:{hasServices:!0}}};this.$crud.index("apiRoutes.qbooking.categories",s).then((e=>{this.categories=e.data,t(e.data)})).catch((e=>{this.$apiResponse.handleError(e,(()=>{t(e)}))}))}))},getServices(e=!1){return new Promise(((t,i)=>{this.loading=!0,this.services=[];let s={refresh:e,params:{filter:{categoryId:this.filters.categoryId}}};this.$crud.index("apiRoutes.qbooking.services",s).then((e=>{this.services=e.data,t(e.data),this.loading=!1})).catch((e=>{this.$apiResponse.handleError(e,(()=>{this.loading=!1,i(e)}))}))}))},getResources(e=!1){return new Promise(((t,i)=>{this.loading=!0,this.resources=[];let s={refresh:e,params:{filter:{services:[this.filters.serviceId]}}};this.$crud.index("apiRoutes.qbooking.resources",s).then((e=>{this.resources=e.data,t(e.data),this.loading=!1})).catch((e=>{this.$apiResponse.handleError(e,(()=>{this.loading=!1,i(e)}))}))}))},getAvailabilities(e=!1){return new Promise(((t,i)=>{this.loading=!0,this.availabilities=[];let s={refresh:e,params:{filter:this.$clone(this.filters)}};this.filters.time&&(s.params.filter.time=[this.settings.timeRangeFilter[`startTime${this.filters.time}`],this.settings.timeRangeFilter[`endTime${this.filters.time}`]]),this.$crud.index("apiRoutes.qbooking.availabilities",s).then((e=>{this.availabilities=e.data.map((e=>({...e,id:this.$uid()}))),t(e.data),this.loading=!1})).catch((e=>{this.$apiResponse.handleError(e,(()=>{this.loading=!1,i(e)}))}))}))},selectItem(e,t){if(this.filters[e]=this.filters[e]==t?null:t,"serviceId"==e){let e=this.services.find((e=>e.id==t));this.serviceForm={...this.$clone(this.dataServiceForm),id:e.formId}}},classSelected(e,t){return this.filters[e]==t?"selected":""},createReservation(){return new Promise(((e,t)=>{this.loading=!0;let i={customerId:this.$store.state.quserAuth.userId,items:[{...this.serviceForm.fields,categoryId:this.selected.category.id,categoryTitle:this.selected.category.title,serviceId:this.selected.service.id,serviceTitle:this.selected.service.title,price:this.selected.service.price,resourceId:this.selected.availability.resource.id,resourceTitle:this.selected.availability.resource.title,startDate:`${this.selected.availability.calendarDate} ${this.selected.availability.startTime}`,endDate:`${this.selected.availability.calendarDate} ${this.selected.availability.endTime}`}]};this.$crud.create("apiRoutes.qbooking.reservations",i).then((e=>{this.successReserve=!0,this.reservationData=e.data.reservation,e.data&&e.data.redirectTo&&this.$helper.openExternalURL(e.data.redirectTo,!0),this.loading=!1})).catch((e=>{this.loading=!1}))}))},actionAfterReservation(e=!1){e?window.location.reload():this.$store.state.quserAuth.authenticated?this.$router.push({name:"qbooking.panel.reservations.index"}):window.location.href=this.$store.state.qsiteApp.baseUrl}}};var M=i(68716),O=i(58120),L=i(99588),G=i(84884),j=i(11032),H=i(2992),J=i(70880),X=i(99140),Z=i(65224),ee=i(65264),te=i(5296),ie=i(29632),se=i(94380),ae=i(95252),le=i.n(ae);const re=(0,M.c)(Y,[["render",U]]),oe=re;le()(Y,"components",{QIcon:O.c,QList:L.c,QItem:G.c,QItemSection:j.c,QItemLabel:H.c,QSeparator:J.c,QBtn:X.c,QBanner:Z.c,QTabPanels:ee.c,QTabPanel:te.c,QOptionGroup:ie.c,QScrollArea:se.c})}}]);
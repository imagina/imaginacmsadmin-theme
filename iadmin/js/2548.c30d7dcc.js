"use strict";(globalThis["webpackChunkadmin_quasar"]=globalThis["webpackChunkadmin_quasar"]||[]).push([[2548],{72548:(e,t,r)=>{r.r(t),r.d(t,{default:()=>H});var n=r(92444),a=r(74044),i={class:"row q-pa-md"},s={class:"col-12"},o={key:2},l={key:0,class:"row q-pa-md q-my-md justify-center"},c={key:1,class:"row q-pa-md q-my-md justify-center"},u={key:2,class:"row q-pa-md justify-center"},d={class:"tw-text-lg tw-font-bold"},f={key:3,class:"row q-col-gutter-md q-pa-md"},m={class:"col-12 col-md-3"},g={class:"average-card q-pa-md"},v={class:"tw-text-gray-400 tw-text-xs tw-font-semibold"},p={class:"tw-text-lg tw-font-bold"},y={class:"row"};function h(e,t,r,h,w,b){var A=(0,n.E1)("dynamicFilter"),k=(0,n.E1)("not-result"),x=(0,n.E1)("v-chart"),q=(0,n.E1)("inner-loading");return(0,n.Wz)(),(0,n.An)("div",null,[(0,n.QD)("div",i,[(0,n.QD)("div",s,[(0,n.K2)(A,{systemName:"telemetry.graphs",filters:e.dynamicFilters,"onUpdate:modelValue":t[0]||(t[0]=function(t){return e.updateDynamicFilterValues(t)})},null,8,["filters"])])]),e.isDeviceSelected?(0,n.g1)("",!0):((0,n.Wz)(),(0,n.Az)(k,{key:0,class:"row q-pa-md q-my-md justify-center",label:this.$tr("itelemetry.cms.form.selectDevice")},null,8,["label"])),e.notResult?((0,n.Wz)(),(0,n.Az)(k,{key:1,class:"row q-pa-md q-my-md justify-center"})):(0,n.g1)("",!0),e.isDeviceSelected?((0,n.Wz)(),(0,n.An)("div",o,[e.showHistory?((0,n.Wz)(),(0,n.An)("div",l,[(0,n.K2)(x,{class:"chistoric-chart",option:e.history,autoresize:""},null,8,["option"])])):(0,n.g1)("",!0),e.showAverages?((0,n.Wz)(),(0,n.An)("div",c,[(0,n.K2)(x,{class:"average-chart",option:e.averages,autoresize:""},null,8,["option"])])):(0,n.g1)("",!0),e.showAverages?((0,n.Wz)(),(0,n.An)("div",u,[(0,n.QD)("span",d,(0,a.WA)(e.averagesTitleByRange),1)])):(0,n.g1)("",!0),e.showAverages?((0,n.Wz)(),(0,n.An)("div",f,[((0,n.Wz)(!0),(0,n.An)(n.ae,null,(0,n.mi)(e.getAverages(),(function(e,t){return(0,n.Wz)(),(0,n.An)("div",m,[(0,n.QD)("div",g,[(0,n.QD)("div",v,(0,a.WA)(e.label),1),(0,n.QD)("span",p,(0,a.WA)(e.average.toFixed(4)),1)])])})),256))])):(0,n.g1)("",!0)])):(0,n.g1)("",!0),(0,n.QD)("div",y,[(0,n.K2)(q,{visible:e.loading},null,8,["visible"])])])}var w=r(75836),b=r(20584);const A={getSensors:function(e){return void 0===e&&(e={}),new Promise((function(t,r){var n={refresh:!0,params:e};b.c.index("apiRoutes.qtelemetry.sensors",n).then((function(e){t(e.data)})).catch((function(e){return r(e)}))}))},getRecords:function(e){return void 0===e&&(e={}),new Promise((function(t,r){var n={refresh:!0,params:e};n.params.include="device,logs",b.c.index("apiRoutes.qtelemetry.records",n).then((function(e){t(e.data)})).catch((function(e){return r(e)}))}))}};var k=r(8932),x=r(49456),q=r.n(x),D=function(){return D=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r],t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},D.apply(this,arguments)};function F(e,t){var r="YYYY-MM-DD",a={},i=(0,w.cB)({loading:!1,columns:null,sensors:null,records:[],logs:null,dynamicFilterValues:{},dynamicFilters:{deviceId:{value:null,type:"select",quickFilter:!0,loadOptions:{apiRoute:"apiRoutes.qtelemetry.devices",select:{label:"title",id:"id"}},props:{label:"".concat(k._s.tr("itelemetry.cms.form.devices"),"*"),clearable:!0}},date:{value:{type:"customRange",from:q()().startOf("week").format(r),to:q()().endOf("week").format(r)},type:"dateRange",quickFilter:!0,props:{label:"".concat(k._s.tr("isite.cms.form.date"),"*"),clearable:!0,removeTime:!0,autoClose:!0}}},averages:null,history:null}),s={isDeviceSelected:(0,n.S6)((function(){return i.dynamicFilterValues.deviceId})),notResult:(0,n.S6)((function(){return!i.records.length&&s.isDeviceSelected.value&&!i.loading})),showAverages:(0,n.S6)((function(){return!i.loading&&i.averages&&i.records.length})),showHistory:(0,n.S6)((function(){return!i.loading&&i.history&&i.records.length})),averagesTitleByRange:(0,n.S6)((function(){return k._s.tr("itelemetry.cms.averagesByRange",{from:i.dynamicFilterValues.date.from,to:i.dynamicFilterValues.date.to})}))},o={init:function(){},updateDynamicFilterValues:function(e){i.dynamicFilterValues=e,s.isDeviceSelected.value&&o.getData()},getData:function(){var e,t;(null===(e=i.dynamicFilterValues)||void 0===e?void 0:e.deviceId)&&(null===(t=i.dynamicFilterValues)||void 0===t?void 0:t.date)&&(i.loading=!0,o.getSensors().then((function(e){i.columns=o.getColumns(),o.getRecords().then((function(e){i.logs=o.mapLogs(e),o.updateGraphs(),i.loading=!1}))})))},getColumns:function(){var e=i.sensors.map((function(e){return{name:"sensor_".concat(e.id),field:"logs",label:e.title,align:"center",format:function(t){if(t){var r=t.find((function(t){return t.sensorId==e.id}));if(r&&(null===r||void 0===r?void 0:r.value))return r.value}return"-"}}}));return e},getSensors:function(){return new Promise((function(e,t){var r={filter:{deviceId:i.dynamicFilterValues.deviceId}};A.getSensors(r).then((function(t){i.sensors=t,e(t)}))}))},getRecords:function(){return new Promise((function(e,t){var r={filter:D({},i.dynamicFilterValues)};A.getRecords(r).then((function(t){i.records=t,e(t)}))}))},mapLogs:function(e){var t=[];return e.forEach((function(e){e.logs.forEach((function(r){var n=i.sensors.find((function(e){return e.id==r.sensorId}));t.push({date:e.createdAt,value:r.value,sensorId:r.sensorId,name:n.title||n.id})}))})),t},updateGraphs:function(){o.drawAverages(),o.drawHistory()},getAverages:function(){if(!i.logs)return[];var e=i.logs,t=[];return i.sensors.forEach((function(r){var n=e.filter((function(e){return e.sensorId==r.id}))||null;if(n&&n.length){var a=n.reduce((function(e,t){return e+t.value}),0),i=a/n.length;t.push({label:r.title||r.id,average:i,length:n.length,sum:a})}})),t},drawAverages:function(){var e=o.getAverages();i.averages={title:{text:k._s.tr("itelemetry.cms.averagesGraph"),left:"center"},toolbox:{feature:{saveAsImage:{show:!0,title:k._s.tr("itelemetry.cms.form.saveImage"),pixelRatio:3}}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"4%",right:"4%",bottom:"4%",containLabel:!0},xAxis:{type:"category",axisTick:{alignWithLabel:!0},data:e.map((function(e){return e.label}))},yAxis:{type:"value"},series:[{type:"bar",label:{show:!0,position:"inside"},data:e.map((function(e){return e.average.toFixed(2)}))}]}},drawHistory:function(){if(!i.logs)return[];var e=i.records.map((function(e){return e.createdAt}));e=Array.from(new Set(e));var t=[];i.sensors.forEach((function(e){t.push({name:e.title,type:"line",stack:"Total",emphasis:{focus:"series"},label:{show:!0,position:"top"},data:i.logs.filter((function(t){return t.sensorId==e.id}))})})),i.history={tooltip:{trigger:"axis",position:function(e){return[e[0],"10%"]}},title:{text:k._s.tr("itelemetry.cms.historicalGraph"),left:"center"},legend:{type:"scroll",top:"10%",data:i.sensors.map((function(e){return e.title}))},grid:{top:"30%",left:"4%",right:"4%",bottom:"4%",containLabel:!0},toolbox:{feature:{restore:{},saveAsImage:{show:!0,title:k._s.tr("itelemetry.cms.form.saveImage"),pixelRatio:3}}},xAxis:{type:"category",boundaryGap:!1,data:e},yAxis:{type:"value",boundaryGap:[0,"100%"]},dataZoom:[{type:"inside"},{}],series:t}}};return(0,n.u2)((function(){o.init()})),D(D(D(D({},a),(0,w.kx)(i)),s),o)}var R=r(1436),I=r(30292),S=r(49304),z=r(32544),W=r(33282),V=r(88380),_=r(60264),E=r(49464),j=r(34096),Q=r(42444),T=r(28056),C=r(49076),G=r(41198),O=r(40288),P=r(15992);(0,I.Y)([S.k,z.k,W.k,V.k,_.k,E.k,Q.k,T.k,C.k,G.k,O.k,P.k]);const L=(0,n._M)({components:{dynamicFilter:R.c,VChart:j.cp},setup:function(e,t){var r=t.emit;return F(e,r)}});var Y=r(68716);const B=(0,Y.c)(L,[["render",h]]),H=B}}]);